# 开发原则与技术实践沉淀

本文档沉淀了项目开发过程中的核心原则与关键技术问题的处理经验，旨在提升代码质量并避免重复踩坑。

---

## 1. 编程与问题解决原则

### 精准对位，拒绝盲目尝试
在着手修改代码前，必须进行深度的问题定位。避免在未弄清根因的情况下，基于主观臆断进行“试错式”编程。盲目尝试往往会导致逻辑复杂度无意义地攀升，最终使系统变得难以维护。

### 文档先行与最佳实践
面对复杂的技术挑战（如 3D 渲染、复杂的状态管理等），应主动检索官方文档、社区深度讨论（如 GitHub Issues）以及业内的通用处理方式。优先采用经过验证的**最佳实践（Best Practices）**，确保方案的专业性与稳健性。

### 保持逻辑极简
如果一个问题的解决方案导致代码变得极其复杂且晦涩，那么往往说明切入问题的方向已经偏离。最优秀的方案通常具备极高的清晰度与极低的耦合度。

---

## 2. 3D 预览图生成 (Asset Generation) 经验

### 渲染管线分离 (Pipeline Separation)
**核心经验**：将“交互视图（Interactive View）”与“资产生成（Asset Generation）”完全分离。
- **做法**：在后台维护一个隐藏的、尺寸锁死在目标分辨率（如 1024x768）的专用渲染器实例。
- **收益**：确保生成的资产具备物理级的点对点精度，不受用户当前预览窗口尺寸、DPI 或缩放比例的影响，从源头上解决画质模糊问题。

### 物理像素对齐与重采样
**核心经验**：画质模糊的根因通常是“低像素截图 + 二次拉伸”。
- **做法**：确保截取的 Canvas 物理尺寸与最终输出尺寸严格 1:1 对应。通过锁定渲染器缓冲区尺寸，避免任何形式的像素插值。
- **细节**：在截图瞬间通过 `requestAnimationFrame` 确保 GPU 已完成在高分辨率下的帧重绘。

### WebGL 上下文稳定性
**核心经验**：避免在截图期间进行剧烈的 DOM 结构变动。
- **做法**：若需调整截图视角或尺寸，应在当前 DOM 位置通过样式偏移（如 `fixed` 布局推至屏幕外）来完成。
- **收益**：避免了 DOM 挂载点改变导致的 WebGL 上下文丢失，消除了捕获过程中的瞬间闪烁或黑屏现象。

### 导出质量优化
- **格式选择**：对于预览图展示，采用 `image/jpeg` 并设置 `0.9` 以上的质量参数，可以在保证视觉锐利度的同时，维持合理的图片体积。
- **资产管道思维**：将每一次截图视为一次微型的“离屏渲染任务”，而非简单的 UI 快照。

---

## 3. 响应式图片处理 (Responsive Image System)

### 动态缩略与按需下发
**核心经验**：全量加载高清原图会极大损害移动端性能，而固定低分辨率压缩又会牺牲高清屏体验。
- **方案**：利用“Next.js `Image` 组件 + 阿里云 OSS 动态缩略参数（`x-oss-process`）”实现业内最优解。
- **做法**：实现自定义 `aliyunLoader`，根据组件请求的 `width` 动态计算 OSS 指令，自动适配不同 DPR（设备像素比）的屏幕。

### 解决 Server Components 序列化问题
**核心经验**：Next.js 不允许在 Server Components 中将自定义函数（如 Loader）直接作为 Props 传递给客户端组件。
- **做法**：封装 [ResponsiveOSSImage.tsx](file:///Users/linpengfei/work/tesla-studio-monorepo/apps/web/src/components/image/ResponsiveOSSImage.tsx) 客户端组件，在内部硬编码 `loader` 逻辑。
- **收益**：避免了运行时报错，同时在详情页等 Server Component 场景下保留了极其关键的响应式图片能力。

### 布局稳定性 (CLS 优化)
- **做法**：配合 `aspect-[4/3]` 容器与 `sizes` 属性。
- **收益**：确保浏览器在图片下载前就能预留准确位置，完美避开布局抖动，提升 Core Web Vitals (LCP/CLS) 指标。

---

## 4. 贴图旋转与方向标准 (Texture Orientation Standards)

**核心原则**：为了确保 3D 预览、画廊展示与下载资产的 100% 一致性，系统采用“资产端预校正”策略。

### 官方规格 (Official Spec)
*   **Model 3/Y**: 1024x1024，**车头朝上** (Heading UP)。
*   **Cybertruck**: 1024x768，**车头朝左** (Heading LEFT)。

### 自动处理流程 (Non-negotiable)
*   **AI 生成处理 (`route.ts`)**: 系统采用“云端实时纠偏”策略。API 移除本地 `sharp` 计算，直接将原始图上传，存储并在 `texture_url` 中包含 OSS 图像处理指令：
    - **Cybertruck**: `?x-oss-process=image/rotate,90/resize,w_1024,h_768`
    - **Model 3/Y**: `?x-oss-process=image/rotate,180/resize,w_1024,h_1024`
*   **DIY 贴画处理 (`StickerEditor.tsx`)**: 合成逻辑在客户端 Canvas 中执行标准方向输出，确保结果资产符合上述规格。
*   **渲染器逻辑 (`ModelViewer.tsx`)**: 3D 查看器应默认信任动态资产的方向，**禁止**在渲染层添加针对动态贴图的二次旋转偏移。
*   **参数合并支持 (`images.ts`)**: `getOptimizedImageUrl` 函数支持将业务层的动态缩放参数与数据库中的预设旋转参数进行智能合并。
> [!IMPORTANT]
> 此逻辑是系统性的，严禁在未同步修改生成端的情况下，为了修正某个车型的预览方向而调整 `ModelViewer.tsx` 或 `viewer-config.json`。
